<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Worship Manager - Pro</title>
    <link rel="icon" type="image/png" href="ALABANZA_logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        midnight: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', primary: '#6366f1', accent: '#8b5cf6' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: #e2e8f0; height: 100dvh; overflow: hidden; margin: 0; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.35s ease-out forwards; }
        .glass-card { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-nav { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.05); }
        .input-midnight { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); color: white; outline: none; }
        .input-midnight:focus { border-color: #6366f1; }
        .pin-input { -webkit-text-security: disc; letter-spacing: 0.5em; text-align: center; font-size: 2.5rem; padding: 1rem 0; caret-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .preserve-lines { white-space: pre-wrap; word-wrap: break-word; line-height: 1.8; }
        .role-badge { background: linear-gradient(90deg, #6366f1, #8b5cf6); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #6366f1; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex justify-center">

    <div class="w-full max-w-md h-full flex flex-col border-x border-white/5 shadow-2xl relative">
        <div id="toast-container" class="absolute top-6 left-6 right-6 z-50 pointer-events-none flex flex-col gap-3"></div>
        <div id="loading-screen" class="absolute inset-0 z-50 bg-slate-900 flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="text-indigo-400 text-xs font-bold tracking-[0.3em] uppercase">Sincronizando...</p>
        </div>
        <div id="app" class="flex-1 overflow-y-auto no-scrollbar relative hidden"></div>
        <div id="modal-overlay" class="fixed inset-0 bg-black/80 z-40 hidden flex items-center justify-center p-4 backdrop-blur-md">
            <div id="modal-content" class="glass-card w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-slide-up relative bg-[#1e293b]"></div>
        </div>
        <div id="bottom-nav" class="flex-shrink-0 h-20 flex justify-around items-center glass-nav z-30 hidden">
            <button onclick="window.navigate('dashboard')" class="flex flex-col items-center justify-center w-16 h-full text-slate-400 hover:text-indigo-400 transition-colors gap-1"><i data-lucide="calendar-days" width="20"></i><span class="text-[9px] font-bold uppercase tracking-tighter">Eventos</span></button>
            <button onclick="window.navigate('library')" class="flex flex-col items-center justify-center w-16 h-full text-slate-400 hover:text-indigo-400 transition-colors gap-1"><i data-lucide="music-4" width="20"></i><span class="text-[9px] font-bold uppercase tracking-tighter">Canciones</span></button>
            <button onclick="window.navigate('admin')" class="flex flex-col items-center justify-center w-16 h-full text-slate-400 hover:text-indigo-400 transition-colors gap-1"><i data-lucide="user-circle" width="20"></i><span class="text-[9px] font-bold uppercase tracking-tighter">Perfil</span></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyAIYzO5QPQ4kIoiDXarzZECs0NWOy_tMG0", authDomain: "worshipmanager-631ca.firebaseapp.com", databaseURL: "https://worshipmanager-631ca-default-rtdb.firebaseio.com", projectId: "worshipmanager-631ca", storageBucket: "worshipmanager-631ca.firebasestorage.app", messagingSenderId: "830090793199", appId: "1:830090793199:web:bf7804cb69d2aad187cb1a" };
        const firebaseApp = initializeApp(firebaseConfig);
        const db = getDatabase(firebaseApp);
        const dbRef = ref(db, 'worshipManagerData');

        const INITIAL_STATE = { view: 'login', userRole: null, selectedEventId: null, events: [], teamDb: [], songsDb: [], searchLib: '', liveSongIndex: 0, liveTab: 'chords' };
        let state = { ...INITIAL_STATE };
        let isFirstLoad = true;

        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            if (data) { state.events = data.events || []; state.teamDb = data.teamDb || []; state.songsDb = data.songsDb || []; }
            if (isFirstLoad) { document.getElementById('loading-screen').style.display = 'none'; document.getElementById('app').classList.remove('hidden'); isFirstLoad = false; }
            if (!document.activeElement || (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA')) render();
        });

        const saveState = () => set(dbRef, { events: state.events || [], teamDb: state.teamDb || [], songsDb: state.songsDb || [] });

        window.navigate = (v, id = null) => { state.view = v; if (id) state.selectedEventId = id; render(); };
        window.loginAsMusician = () => { state.userRole = 'musician'; window.navigate('dashboard'); };
        window.logout = () => { state.userRole = null; window.navigate('login'); };
        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        window.verifyAdmin = (e) => { e.preventDefault(); if (document.getElementById('adminPin').value === '1717') { state.userRole = 'admin'; window.closeModal(); window.navigate('dashboard'); } else { showNotification("Pin Incorrecto", "error"); } };

         window.handleNewEvent = (e) => {
            e.preventDefault();
            const f = e.target;
            const newEvent = {
                id: Date.now(), title: f.title.value, date: f.date.value, time: f.time.value,
                type: f.type.value, notes: f.notes.value, songIds: [], teamIds: []
            };

            state.events.push(newEvent);
            saveState();
            showNotification("Evento guardado");

            const msg = `*NUEVO EVENTO PROGRAMADO* üìÖ%0A%0A` +
                        `*T√≠tulo:* ${newEvent.title}%0A` +
                        `*Fecha:* ${newEvent.date}%0A` +
                        `*Hora:* ${newEvent.time}%0A` +
                        `*Tipo:* ${newEvent.type.toUpperCase()}%0A` +
                        `*Notas:* ${newEvent.notes || 'N/A'}%0A%0A` +
                        `_Revisa el Setlist en la App_`;

            setTimeout(() => {
                window.open(`https://api.whatsapp.com/send?text=${msg}`, '_blank');
                window.navigate('dashboard');
            }, 800);
        };

        window.deleteEvent = (id) => { if(confirm("¬øEliminar este evento?")) { state.events = state.events.filter(e => e.id != id); saveState(); window.navigate('dashboard'); } };

        window.addSongToDb = (e) => { e.preventDefault(); const f=e.target; state.songsDb.push({ id: Date.now(), title: f.title.value, artist: f.artist.value, key: f.key.value || "C", chords: f.chords.value, lyrics: f.lyrics.value }); saveState(); f.reset(); showNotification("Canci√≥n guardada"); render(); };
        window.assignSongToEvent = (songId) => { const ev = state.events.find(e => e.id == state.selectedEventId); if(!ev.songIds) ev.songIds = []; if(!ev.songIds.includes(songId)) { ev.songIds.push(songId); saveState(); window.closeModal(); render(); } };
        window.removeSongFromEvent = (songId) => { const ev = state.events.find(e => e.id == state.selectedEventId); ev.songIds = ev.songIds.filter(id => id != songId); saveState(); render(); };
        window.deleteSongFromDb = (id) => { if(confirm("¬øEliminar canci√≥n?")) { state.songsDb = state.songsDb.filter(s => s.id != id); saveState(); render(); } };

        window.createMember = (e) => { e.preventDefault(); const f=e.target; state.teamDb.push({id:Date.now(),name:f.name.value,role:f.role.value,instrument:f.instrument.value}); saveState(); render(); };
        window.assignMember = (id) => { const ev=state.events.find(e=>e.id == state.selectedEventId); if(!ev.teamIds) ev.teamIds=[]; ev.teamIds.push(id); saveState(); window.closeModal(); render(); };
        window.removeMemberFromEvent = (id) => { const ev=state.events.find(e=>e.id == state.selectedEventId); ev.teamIds=ev.teamIds.filter(t=>t != id); saveState(); render(); };
        window.deleteMemberDb = (id) => { if(confirm("¬øEliminar?")){ state.teamDb=state.teamDb.filter(m=>m.id!==id); state.events.forEach(e=>{if(e.teamIds)e.teamIds=e.teamIds.filter(t=>t!==id)}); saveState(); render(); } };

        window.handleSearchLib = (e) => { state.searchLib = e.target.value.toLowerCase(); updateSongListUI('library-song-container', state.searchLib); };
        window.handleSearchModal = (e) => { state.searchModal = e.target.value.toLowerCase(); updateSongListUI('modal-song-list', state.searchModal, true); };

        function updateSongListUI(containerId, query, isModal = false) {
            const container = document.getElementById(containerId);
            if(!container) return;
            const ev = isModal ? state.events.find(ev => ev.id == state.selectedEventId) : null;
            const filtered = state.songsDb.filter(s => {
                const match = s.title.toLowerCase().includes(query) || s.artist.toLowerCase().includes(query);
                return isModal ? (match && !ev.songIds?.includes(s.id)) : match;
            });
            container.innerHTML = filtered.map(s => `<div class="glass-card p-4 rounded-xl mb-3 flex justify-between items-center active:scale-95 transition-all"><div onclick="${isModal ? `window.assignSongToEvent(${s.id})` : `window.viewSongDetail(${s.id})`}" class="flex items-center gap-4 flex-1 truncate"><div class="bg-slate-900 w-12 h-10 flex-shrink-0 rounded-lg flex items-center justify-center text-indigo-400 border border-slate-700 font-bold text-sm shadow-inner">${s.key}</div><div class="truncate"><h3 class="font-bold text-slate-200 text-sm truncate uppercase tracking-tight">${s.title}</h3><p class="text-[10px] text-slate-500 font-bold uppercase truncate">${s.artist || 'ALABANZA'}</p></div></div>${(!isModal && state.userRole === 'admin') ? `<button onclick="window.deleteSongFromDb(${s.id})" class="text-slate-600 p-2"><i data-lucide="trash-2" width="14"></i></button>` : ''}</div>`).join('');
            lucide.createIcons();
        }

        window.viewSongDetail = (id) => {
            const s = state.songsDb.find(song => song.id == id);
            showModal(`<div class="flex justify-between items-start mb-6"><div><h2 class="text-xl font-bold text-white uppercase">${s.title}</h2><p class="text-indigo-400 font-bold uppercase text-[10px] tracking-widest">${s.artist || 'ALABANZA'}</p></div><div class="bg-midnight-primary px-3 py-1.5 rounded-xl text-white font-bold text-base shadow-lg">${s.key}</div></div><div class="space-y-6 max-h-[50vh] overflow-y-auto no-scrollbar"><div><h4 class="text-[9px] font-bold text-slate-500 uppercase mb-2 tracking-widest">Acordes</h4><pre class="bg-black/40 p-4 rounded-2xl font-mono text-xs text-emerald-400 preserve-lines border border-slate-800">${s.chords || '---'}</pre></div><div><h4 class="text-[9px] font-bold text-slate-500 uppercase mb-2 tracking-widest">Letra</h4><div class="bg-slate-800/30 p-4 rounded-2xl text-xs text-white preserve-lines leading-relaxed">${s.lyrics || '---'}</div></div></div><button onclick="window.closeModal()" class="w-full mt-6 bg-slate-800 text-slate-300 py-3 rounded-xl font-bold text-xs uppercase border border-slate-700">Cerrar</button>`);
        };

        function render() {
            const app = document.getElementById('app'); const nav = document.getElementById('bottom-nav');
            app.innerHTML = '';
            if(state.view === 'login') { nav.classList.add('hidden'); renderLogin(app); }
            else {
                nav.classList.remove('hidden');
                if(state.view === 'dashboard') renderDashboard(app);
                else if(state.view === 'library') renderLibrary(app);
                else if(state.view === 'create') renderCreate(app);
                else if(state.view === 'detail') renderDetail(app);
                else if(state.view === 'admin') renderAdmin(app);
                else if(state.view === 'live') { nav.classList.add('hidden'); renderLive(app); }
            }
            lucide.createIcons();
        }

        function renderLogin(c) {
            c.innerHTML = `<div class="flex flex-col items-center justify-center min-h-full p-8 text-center animate-slide-up"><img src="ALABANZA_logo.png" alt="Logo" class="w-32 h-32 object-contain mb-6 drop-shadow-[0_0_15px_rgba(99,102,241,0.5)]"><h1 class="text-4xl font-bold text-white mb-1 tracking-tight">Worship</h1><h2 class="text-indigo-400 font-bold text-2xl mb-6 tracking-[0.2em] uppercase">Manager</h2><div class="px-4 mb-10 italic"><p class="text-slate-400 text-sm leading-relaxed">"Cantadle c√°ntico nuevo; hacedlo bien, ta√±endo con j√∫bilo."</p><p class="text-indigo-400 text-[10px] font-bold uppercase tracking-widest mt-2">Salmo 33:3</p></div><div class="w-full space-y-4"><button onclick="window.loginAsMusician()" class="w-full glass-card p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800/40 transition-all"><div class="w-12 h-12 rounded-full bg-slate-900 flex items-center justify-center text-indigo-400 border border-slate-700 shadow-inner"><i data-lucide="headphones" width="22"></i></div><div class="font-bold text-white uppercase text-sm tracking-widest">Soy M√∫sico</div></button><button onclick="window.promptAdminLogin()" class="w-full glass-card p-5 rounded-2xl flex items-center gap-4 hover:bg-slate-800/40 transition-all"><div class="w-12 h-12 rounded-full bg-slate-900 flex items-center justify-center text-violet-400 border border-slate-700 shadow-inner"><i data-lucide="shield" width="22"></i></div><div class="font-bold text-white uppercase text-sm tracking-widest">Soy L√≠der</div></button></div></div>`;
        }

        function renderDashboard(c) {
            const isAdmin = state.userRole === 'admin';
            const sorted=[...state.events].sort((a,b)=>new Date(a.date)-new Date(b.date));
            const list = sorted.map(ev=>{
                const d=formatDate(ev.date);
                const colors = { "ensayo": "bg-midnight-primary", "servicio": "bg-emerald-500", "evento": "bg-violet-500" };
                return `<div onclick="window.navigate('detail', ${ev.id})" class="glass-card p-5 rounded-2xl mb-4 relative overflow-hidden active:scale-95 transition-all"><div class="absolute top-4 right-4"><span class="${colors[ev.type]} text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-lg">${ev.type}</span></div><div class="flex items-center gap-5 pt-2"><div class="bg-slate-900 w-16 h-16 rounded-2xl flex flex-col items-center justify-center border border-slate-700 shadow-inner"><span class="text-[10px] font-bold text-slate-500 uppercase">${d.month}</span><span class="text-2xl font-bold text-white">${d.day}</span></div><div class="flex-1"><h3 class="font-bold text-white text-lg leading-tight mb-2 pr-12">${ev.title}</h3><p class="text-slate-400 text-xs flex items-center gap-1 font-medium"><i data-lucide="clock" width="12"></i> ${ev.time}</p></div></div></div>`;
            }).join('');
            c.innerHTML = `<div class="p-6 pt-8 animate-slide-up h-full"><div class="flex justify-between items-start mb-8"><div><h1 class="text-2xl font-bold text-white mb-1 tracking-tight uppercase">ALABANZA</h1><div class="role-badge px-3 py-1 rounded-full text-[9px] font-bold text-white uppercase tracking-widest inline-flex items-center gap-1.5"><i data-lucide="${isAdmin?'shield':'headphones'}" width="10"></i> ${isAdmin?'L√çDER':'M√öSICO'}</div></div>${isAdmin?`<button onclick="window.navigate('create')" class="bg-midnight-primary w-12 h-12 rounded-full flex items-center justify-center text-white shadow-lg"><i data-lucide="plus" width="24"></i></button>`:''}</div><div class="pb-10">${list || '<p class="text-slate-500 text-center py-10 italic">No hay eventos</p>'}</div></div>`;
        }

        window.startLiveMode = () => { state.liveSongIndex = 0; window.navigate('live'); };

        function renderLive(app) {
            const ev = state.events.find(e => e.id == state.selectedEventId);
            if (!ev || !ev.songIds || ev.songIds.length === 0) { window.navigate('detail'); return; }
            const song = state.songsDb.find(s => s.id == ev.songIds[state.liveSongIndex]);
            if (!song) { window.navigate('detail'); return; }

            const tabs = ev.songIds.map((sid, i) => {
                const s = state.songsDb.find(x => x.id == sid);
                return `<button onclick="window.jumpToSong(${i})" class="flex-shrink-0 px-5 py-2.5 rounded-full text-xs font-bold uppercase border ${i===state.liveSongIndex ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg' : 'bg-slate-800 text-slate-500 border-slate-700'}">${i+1}. ${s.title}</button>`;
            }).join('');

            app.innerHTML = `<div id="live-root" class="h-full bg-slate-900 flex flex-col relative overflow-hidden">
                <div class="glass-nav z-20 border-b border-white/5 shadow-2xl flex-shrink-0">
                    <div class="flex justify-between items-center p-4 pb-2">
                        <button onclick="window.navigate('detail')" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-800 text-white shadow-lg border border-white/10"><i data-lucide="arrow-left" width="20"></i></button>
                        <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Live Mode</span></div>
                        <div class="bg-midnight-primary px-3 py-1 rounded-lg font-bold text-sm text-white">${song.key}</div>
                    </div>
                    <div class="w-full overflow-x-auto no-scrollbar px-4 py-4 flex gap-3 shadow-inner">${tabs}</div>
                    <div class="px-4 pb-4 flex gap-3"><button onclick="window.setLiveTab('chords')" id="btn-view-chords" class="flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center transition-all">Acordes</button><button onclick="window.setLiveTab('lyrics')" id="btn-view-lyrics" class="flex-1 py-3 rounded-xl text-sm font-bold flex items-center justify-center transition-all">Letra</button></div>
                </div>
                <div id="live-content-area" class="flex-1 overflow-y-auto p-6 text-center no-scrollbar"><h2 class="text-3xl font-bold text-white mb-2 uppercase tracking-tight">${song.title}</h2><p class="text-indigo-400 text-sm uppercase tracking-widest mb-10 font-bold">${song.artist||''}</p><div id="live-main-content" class="pb-32"></div></div>
            </div>`;
            updateLiveDOM();
            lucide.createIcons();
        }

        window.jumpToSong = (i) => { state.liveSongIndex = i; renderLive(document.getElementById('app')); };
        window.setLiveTab = (t) => { state.liveTab = t; updateLiveDOM(); };

        function updateLiveDOM() {
            const ev = state.events.find(e => e.id == state.selectedEventId);
            const song = state.songsDb.find(s => s.id == ev.songIds[state.liveSongIndex]);
            const main = document.getElementById('live-main-content');
            if(!main || !song) return;
            main.innerHTML = state.liveTab === 'chords' ? `<pre class="font-mono text-base md:text-xl text-slate-300 preserve-lines animate-slide-up">${song.chords || ''}</pre>` : `<div class="text-white font-medium text-center text-lg preserve-lines animate-slide-up">${song.lyrics || ''}</div>`;
            document.getElementById('btn-view-chords').className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all ${state.liveTab === 'chords' ? 'bg-midnight-primary text-white shadow-lg' : 'bg-slate-800 text-slate-500'}`;
            document.getElementById('btn-view-lyrics').className = `flex-1 py-3 rounded-xl text-sm font-bold transition-all ${state.liveTab === 'lyrics' ? 'bg-teal-600 text-white shadow-lg' : 'bg-slate-800 text-slate-500'}`;
        }

        const formatDate = (d) => { if(!d) return {day:'--',month:'---',full:''}; const date=new Date(d+'T12:00:00'); return {day:date.getDate(),month:date.toLocaleDateString('es-ES',{month:'short'}).toUpperCase().replace('.',''),full:date.toLocaleDateString()}; };
        const showModal = (h) => { document.getElementById('modal-content').innerHTML=h; document.getElementById('modal-overlay').classList.remove('hidden'); lucide.createIcons(); };
        const showNotification = (m,t='success') => { const toast=document.createElement('div'); toast.className=`glass-card p-4 rounded-xl flex items-center gap-3 shadow-2xl border-l-4 ${t==='error'?'border-red-500':'border-midnight-primary'} animate-slide-up pointer-events-auto z-[100]`; toast.innerHTML = `<span class="text-sm font-bold text-white uppercase tracking-tight">${m}</span>`; document.getElementById('toast-container').appendChild(toast); setTimeout(()=>toast.remove(),3000); };
        window.getIcon = (i) => ({'mic':'mic-2','keys':'music-4','guitar':'guitar','drums':'drum','bass':'music'}[i]||'music');

        window.renderCreate = (c) => { c.innerHTML = `<div class="p-6 pt-8 animate-slide-up h-full flex flex-col"><button onclick="window.navigate('dashboard')" class="text-slate-500 mb-8 flex items-center gap-2 font-medium text-sm hover:text-white"><i data-lucide="arrow-left" width="16"></i> Cancelar</button><h1 class="text-2xl font-bold text-white mb-8">Crear <span class="text-indigo-400">Evento</span></h1><form onsubmit="window.handleNewEvent(event)" class="space-y-6 flex-1 overflow-y-auto no-scrollbar"><div><label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 block">T√≠tulo</label><input type="text" name="title" required placeholder="Ej. Servicio Dominical" class="input-midnight w-full p-4 rounded-xl"></div><div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 block">Fecha</label><input type="date" name="date" required class="input-midnight w-full p-4 rounded-xl text-sm"></div><div><label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 block">Hora</label><input type="time" name="time" required class="input-midnight w-full p-4 rounded-xl text-sm"></div></div><div><label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2 block">Tipo</label><select name="type" class="input-midnight w-full p-4 rounded-xl text-sm"><option value="ensayo">Ensayo</option><option value="servicio">Servicio / Culto</option><option value="evento">Especial</option></select></div><textarea name="notes" placeholder="Notas..." rows="3" class="input-midnight w-full p-4 rounded-xl text-sm"></textarea><button type="submit" class="w-full bg-midnight-primary text-white font-bold py-4 rounded-xl shadow-lg border border-indigo-400">PROGRAMAR EVENTO</button></form></div>`; };
        window.renderLibrary = (c) => { const isAdmin = state.userRole === 'admin'; c.innerHTML = `<div class="p-6 pt-8 animate-slide-up pb-10 h-full flex flex-col"><h1 class="text-2xl font-bold text-white mb-6 tracking-tight uppercase text-center">REPERTORIO</h1><div class="relative mb-6"><i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500" width="16"></i><input oninput="window.handleSearchLib(event)" class="input-midnight w-full rounded-2xl p-4 pl-12 text-sm shadow-inner" placeholder="Buscar canci√≥n..."></div>${isAdmin ? `<form onsubmit="window.addSongToDb(event)" class="glass-card p-5 rounded-2xl mb-8 border-t-4 border-t-midnight-primary shadow-2xl"><h3 class="text-[10px] font-bold text-slate-500 uppercase mb-4 tracking-widest">A√±adir Nueva</h3><div class="grid grid-cols-4 gap-3 mb-3"><div class="col-span-3"><input name="title" required class="input-midnight w-full rounded-xl p-3 text-sm" placeholder="T√≠tulo"></div><div class="col-span-1"><input name="key" class="input-midnight w-full rounded-xl p-3 text-sm text-center font-bold text-indigo-400 uppercase" placeholder="G"></div></div><input name="artist" class="input-midnight w-full rounded-xl p-3 text-xs mb-3" placeholder="Artista"><textarea name="chords" rows="2" class="w-full bg-black/40 rounded-xl p-3 text-xs font-mono text-emerald-400 mb-3 border border-slate-800" placeholder="Acordes..."></textarea><textarea name="lyrics" rows="2" class="input-midnight w-full rounded-xl p-3 text-xs mb-4" placeholder="Letra..."></textarea><button type="submit" class="w-full bg-midnight-primary text-white font-bold py-3 rounded-xl shadow-lg text-xs uppercase tracking-widest">Guardar</button></form>` : ''}<div id="library-song-container" class="flex-1 overflow-y-auto no-scrollbar"></div></div>`; updateSongListUI('library-song-container', ''); };
       // Busca esta l√≠nea y reemplaza todo el contenido de la funci√≥n:
window.renderDetail = (c) => {
    const ev = state.events.find(e => e.id == state.selectedEventId);
    const isAdmin = state.userRole === 'admin';

    const sList = (ev.songIds||[]).map((sid, i) => {
        const s = state.songsDb.find(x => x.id == sid);
        if(!s) return '';
        return `<div class="glass-card p-4 rounded-xl mb-3 flex justify-between items-center"><div class="flex items-center gap-4 flex-1 truncate"><span class="text-slate-600 font-bold">${i+1}</span><div class="truncate"><h3 class="font-bold text-slate-200 text-sm truncate uppercase">${s.title}</h3><p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">${s.artist||'ALABANZA'}</p></div></div><div class="flex items-center gap-3"><div class="bg-slate-900 px-3 py-1 rounded-lg text-indigo-400 font-bold text-xs border border-slate-700 min-w-[36px] text-center">${s.key}</div>${isAdmin?`<button onclick="window.removeSongFromEvent(${s.id})" class="text-slate-600 hover:text-red-400"><i data-lucide="trash-2" width="16"></i></button>`:''}</div></div>`;
    }).join('');

    const tList = (ev.teamIds||[]).map(id=>{
        const m=state.teamDb.find(t=>t.id == id);
        return m ? `<div class="bg-slate-800/40 p-2 rounded-xl border border-slate-700 flex flex-col items-center text-center relative shadow-inner">${isAdmin?`<button onclick="window.removeMemberFromEvent(${m.id})" class="absolute top-1 right-1 text-red-500 opacity-50"><i data-lucide="x" width="12"></i></button>`:''}<div class="w-8 h-8 rounded-full bg-slate-900 flex items-center justify-center text-slate-400 border border-slate-700 mb-1"><i data-lucide="${window.getIcon(m.instrument)}" width="14"></i></div><p class="text-white font-bold text-[9px] truncate w-full px-1">${m.name}</p><p class="text-[7px] text-indigo-300 font-bold uppercase tracking-tighter">${m.role}</p></div>` : ''
    }).join('');

    const colors = { "ensayo": "bg-midnight-primary", "servicio": "bg-emerald-500", "evento": "bg-violet-500" };

    c.innerHTML = `
        <div class="p-6 animate-slide-up pb-10">
            <div class="flex justify-between items-center mb-8">
                <button onclick="window.navigate('dashboard')" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700 shadow-sm"><i data-lucide="arrow-left" width="18"></i></button>
                <span class="text-[10px] font-bold uppercase text-white px-3 py-1 ${colors[ev.type]} rounded-full shadow-lg">${ev.type}</span>
            </div>

            <h1 class="text-3xl font-bold text-white mb-4 leading-tight uppercase tracking-tight">${ev.title}</h1>

            <div class="flex gap-4 text-xs text-slate-400 mb-6 font-medium">
                <span><i data-lucide="calendar" width="12" class="inline"></i> ${formatDate(ev.date).full}</span>
                <span><i data-lucide="clock" width="12" class="inline"></i> ${ev.time}</span>
            </div>

            ${ev.notes ? `
            <div class="mb-8">
                <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Notas del evento</h2>
                <div class="glass-card p-4 rounded-2xl text-xs text-slate-300 leading-relaxed border-l-2 border-l-indigo-500">
                    <p class="italic">"${ev.notes}"</p>
                </div>
            </div>` : ''}

            ${ev.songIds?.length ? `<button onclick="window.startLiveMode()" class="w-full bg-midnight-primary text-white font-bold py-4 rounded-xl shadow-lg mb-10 border border-indigo-400">ABRIR LIVE MODE</button>` : ''}

            <div class="mb-10">
                <div class="flex justify-between mb-4 items-center">
                    <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">M√∫sicos</h2>
                    ${isAdmin?`<button onclick="window.openAddMemberModal()" class="text-indigo-400 text-xs font-bold">+ Asignar</button>`:''}
                </div>
                <div class="grid grid-cols-3 gap-2">
                    ${tList || '<p class="col-span-3 text-slate-600 text-xs text-center py-4 border border-dashed border-slate-800 rounded-xl">Vac√≠o</p>'}
                </div>
            </div>

            <div class="flex justify-between mb-4 items-center">
                <h2 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Setlist</h2>
                ${isAdmin?`<button onclick="window.openAddSongModal()" class="text-indigo-400 text-xs font-bold">+ Repertorio</button>`:''}
            </div>
            <div class="space-y-1 mb-8">
                ${sList || '<p class="text-slate-600 text-xs text-center py-10 border border-dashed border-slate-800 rounded-xl">Lista vac√≠a</p>'}
            </div>

            ${isAdmin ? `<button onclick="window.deleteEvent(${ev.id})" class="w-full mt-6 p-4 border border-red-500/30 text-red-500 font-bold uppercase text-[9px] tracking-widest rounded-xl hover:bg-red-500/10 transition-all">Eliminar Evento</button>` : ''}
        </div>`;
};
        window.renderAdmin = (c) => { const isAdmin = state.userRole === 'admin'; if(!isAdmin){ c.innerHTML=`<div class="p-8 h-full flex flex-col items-center justify-center text-center animate-slide-up"><img src="ALABANZA_logo.png" alt="Logo" class="w-24 h-24 object-contain mb-8 drop-shadow-[0_0_15px_rgba(99,102,241,0.3)]"><h2 class="text-2xl font-bold text-white mb-4 uppercase tracking-tight">Modo M√∫sico</h2><p class="text-slate-400 text-sm mb-10 max-w-[250px] mx-auto">Gracias por tu servicio y dedicaci√≥n. ¬°Nos vemos en el pr√≥ximo encuentro!</p><button onclick="window.logout()" class="w-full bg-slate-800/50 py-4 rounded-xl text-red-400 font-bold border border-red-500/20 uppercase tracking-widest text-xs">Cerrar Sesi√≥n</button></div>`; return; }
            const list=state.teamDb.map(m=>`<div class="flex justify-between p-3 bg-slate-800/30 rounded-xl border border-slate-700 mb-2 items-center"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-900 flex items-center justify-center border border-slate-700 text-slate-400 shadow-inner"><i data-lucide="${window.getIcon(m.instrument)}" width="16"></i></div><div><p class="font-bold text-slate-200 text-sm">${m.name}</p><p class="text-[10px] text-indigo-300 font-bold uppercase tracking-wider">${m.role}</p></div></div><button onclick="window.deleteMemberDb(${m.id})" class="text-slate-600 p-2"><i data-lucide="trash-2" width="16"></i></button></div>`).join('');
            c.innerHTML = `<div class="p-6 pt-8 pb-10 h-full animate-slide-up overflow-y-auto no-scrollbar"><header class="flex justify-between items-center mb-8"><h1 class="text-2xl font-bold text-white uppercase tracking-tighter">Panel L√≠der</h1><button onclick="window.logout()" class="text-[10px] font-bold text-red-400 border border-red-500/30 px-3 py-1 rounded-full uppercase tracking-wider">Salir</button></header><div class="glass-card p-5 rounded-2xl mb-8 border-t-4 border-t-midnight-primary shadow-xl"><h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Nuevo M√∫sico</h2><form onsubmit="window.createMember(event)" class="space-y-4"><input type="text" name="name" required placeholder="Nombre" class="input-midnight w-full p-3 rounded-xl text-sm"><div class="grid grid-cols-2 gap-3"><input type="text" name="role" required placeholder="Rol" class="input-midnight w-full p-3 rounded-xl text-sm"><select name="instrument" class="input-midnight w-full p-3 rounded-xl text-sm"><option value="mic">Voz</option><option value="keys">Piano</option><option value="guitar">Guitarra</option><option value="drums">Bater√≠a</option><option value="bass">Bajo</option><option value="music">Otro</option></select></div><button type="submit" class="w-full bg-slate-800 text-white text-xs font-bold py-3 rounded-xl border border-slate-700 hover:bg-slate-700 transition-colors">Guardar</button></form></div><div class="mb-8"><h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Directorio</h2><div class="space-y-1">${list || '<p class="text-slate-600 text-xs text-center py-4">Sin registros</p>'}</div></div></div>`;
        };

        window.openAddSongModal = () => { showModal(`<div class="flex justify-between mb-6 items-center"><h3 class="font-bold text-white text-lg">A√±adir Canci√≥n</h3><button onclick="window.closeModal()"><i data-lucide="x" width="16"></i></button></div><div class="relative mb-4"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" width="14"></i><input oninput="window.handleSearchModal(event)" class="input-midnight w-full rounded-xl p-3 pl-10 text-xs" placeholder="Buscar en cat√°logo..."></div><div id="modal-song-list" class="space-y-2 max-h-80 overflow-y-auto no-scrollbar pb-4"></div>`); updateSongListUI('modal-song-list', '', true); };
        window.openAddMemberModal = () => { const ev = state.events.find(e=>e.id == state.selectedEventId); const av = state.teamDb.filter(m => !ev.teamIds?.includes(m.id)); let h = `<div class="flex justify-between mb-6 items-center"><h3 class="font-bold text-white text-lg tracking-tight uppercase">Asignar M√∫sico</h3><button onclick="window.closeModal()"><i data-lucide="x" width="16"></i></button></div><div class="space-y-2 max-h-60 overflow-y-auto no-scrollbar pb-4">`; av.forEach(m=>{h+=`<button onclick="window.assignMember(${m.id})" class="w-full text-left p-3 bg-slate-800/50 border border-slate-700 rounded-xl flex items-center gap-3 group transition-all"><div class="w-8 h-8 rounded-full bg-slate-900 flex items-center justify-center text-slate-400 group-hover:bg-midnight-primary group-hover:text-white transition-colors"><i data-lucide="${window.getIcon(m.instrument)}" width="14"></i></div><div><p class="font-bold text-slate-200 text-sm uppercase">${m.name}</p><p class="text-[10px] text-indigo-300 font-bold uppercase tracking-wider">${m.role}</p></div></button>`}); showModal(h + `</div>`); };
        window.promptAdminLogin = () => { showModal(`<div class="text-center"><h3 class="font-bold text-lg mb-6 text-white text-center">Acceso L√≠der</h3><form onsubmit="window.verifyAdmin(event)" class="space-y-6 flex flex-col items-center"><input type="tel" id="adminPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="pin-input w-full bg-slate-900/50 border border-slate-700 rounded-2xl py-4 text-white focus:border-midnight-primary" maxlength="4" autoFocus><button type="submit" class="w-full bg-midnight-primary text-white font-bold py-3.5 rounded-xl">Entrar</button></form></div>`); setTimeout(() => document.getElementById('adminPin').focus(), 100); };
        render();
    </script>
</body>
</html>
